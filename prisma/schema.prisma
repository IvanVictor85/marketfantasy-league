// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model League {
  id             String   @id @default(cuid())
  name           String
  leagueType     String   @default("MAIN") // "MAIN" for Liga Principal, "COMMUNITY" for future leagues
  entryFee       Float    // Entry fee in SOL
  maxPlayers     Int?     // NULL for unlimited (Liga Principal)
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean  @default(true)
  treasuryPda    String   // Solana PDA address
  programId      String?  // Solana Program ID for this league
  adminWallet    String   // Admin wallet address
  protocolWallet String   // Protocol treasury wallet
  emblemUrl      String?  // URL of the selected emblem image
  description    String?  // League description
  status         String   @default("ACTIVE") // League status
  badgeUrl       String?  // Badge URL
  bannerUrl      String?  // Banner URL
  prizeDistribution String  @default("{\"first\": 50, \"second\": 30, \"third\": 20}") // Prize distribution percentages
  totalPrizePool Float   @default(0) // Current total prize pool in SOL
  participantCount Int   @default(0) // Current number of participants
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  teams          Team[]
  leagueEntries  LeagueEntry[]
  competitions   Competition[]

  @@map("leagues")
}

model LeagueEntry {
  id               String   @id @default(cuid())
  leagueId         String
  userId           String   // User ID from authentication
  userWallet       String   // User's Solana wallet address
  transactionHash  String   @unique // Solana transaction signature
  amountPaid       Float    // Amount paid in SOL
  status           String   @default("CONFIRMED") // "PENDING", "CONFIRMED", "FAILED"
  blockHeight      Int?     // Block height of the transaction
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  league           League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, leagueId]) // Previne duplicatas por usuário
  @@map("league_entries")
}

model Team {
  id               String   @id @default(cuid())
  leagueId         String
  userId           String   // User ID from authentication
  userWallet       String   // User's Solana wallet address
  teamName         String
  tokens           String   // JSON array of token symbols only: ["BTC", "ETH", "SOL", ...]. Details fetched from CoinGecko.
  totalScore       Float?   // Calculated performance score
  rank             Int?     // Final ranking in the league
  selectedMascotUrl String? // URL of the selected mascot image
  hasValidEntry    Boolean  @default(false) // Whether user has paid entry fee
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  league           League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, leagueId]) // Previne duplicatas por usuário
  @@map("teams")
}

model Token {
  id          String   @id @default(cuid())
  symbol      String   @unique
  name        String
  coingeckoId String   @unique
  logoUrl     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("tokens")
}

model Competition {
  id          String   @id @default(cuid())
  leagueId    String
  startTime   DateTime
  endTime     DateTime
  status      String   // "pending", "active", "completed"
  winners     String?  // Array of winner wallet addresses (JSON string)
  prizePool   Float    // Total prize pool in SOL
  distributed Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  league      League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  tokens      CompetitionToken[] // Tokens disponíveis para esta competição

  @@map("competitions")
}

model CompetitionToken {
  id            String   @id @default(cuid())
  competitionId String
  tokenId       String   // CoinGecko ID (ex: "bitcoin", "ethereum", "pudgy-penguins")
  symbol        String   // Símbolo (ex: "BTC", "ETH", "PENGU")
  name          String   // Nome completo (ex: "Bitcoin", "Ethereum", "Pudgy Penguins")
  imageUrl      String   // URL da imagem do token
  marketCapRank Int?     // Ranking no momento do snapshot
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)

  @@unique([competitionId, tokenId]) // Previne duplicatas na mesma competição
  @@index([competitionId])
  @@map("competition_tokens")
}

model PriceHistory {
  id          String   @id @default(cuid())
  tokenSymbol String
  price       Float
  timestamp   DateTime
  source      String   @default("coingecko")

  @@map("price_history")
  @@index([tokenSymbol, timestamp])
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  publicKey  String?  @unique // Carteira Solana (única por usuário)
  name       String   // Nome do Time
  username   String?  @unique // Nome de usuário único
  avatar     String?
  twitter    String?
  discord    String?
  bio        String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  authTokens AuthToken[]
  teams      Team[]
  leagueEntries LeagueEntry[]

  @@map("users")
}

model VerificationCode {
  id        String   @id @default(cuid())
  email     String   @unique
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([email])
  @@map("verification_codes")
}

model AuthToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("auth_tokens")
}
model WalletNonce {
  id            String   @id @default(cuid())
  nonce         String   @unique
  expiresAt     DateTime
  used          Boolean  @default(false)
  usedAt        DateTime?
  walletAddress String? // Wallet que usou o nonce (após verificação)
  createdAt     DateTime @default(now())

  @@index([nonce])
  @@index([expiresAt])
  @@map("wallet_nonces")
}
